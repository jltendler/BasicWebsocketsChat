<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js + WebSocket Demo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app">
        <!-- Sidebar -->
        <div class="sidebar">
            <h3>Online Users</h3>
            <ul class="user-list">
                <li v-for="user in users" :key="user" class="online-username" :class="{ me: user === username}"
                    :title="user"> <!-- ability to see full username even if it's truncated for length -->
                    {{ user }} {{ user === username ? '[You]' : '' }}
                </li>
                <li v-if="!isConnected" style="color: #999; font-style: italic;">Disconnected</li>
                <li v-else-if="users.length === 0" style="color: #999; font-style: italic;">No users online</li>
            </ul>
        </div>

        <!-- Main Chat Area -->
        <div class="main-content">
            <h1>Vue.js + WebSocket Chat</h1>

            <div class="controls">
                <label>Username:</label>
                <input v-model="username" maxlength="18" @keyup.enter="handleRename" placeholder="Enter Username">
                <!--Save on enter, or button press -->
                <button @click="handleRename" :disabled="!isConnected || username === previousUsername">Save</button>
                <button @click="toggleConnection" :class="{ disconnect: isConnected }">
                    {{ isConnected ? 'Disconnect' : 'Connect' }}
                </button>
                <div class="status" :class="{ connected: isConnected, disconnected: !isConnected }">
                    {{ connectionStatus }}
                </div>
            </div>

            <div class="chat-window" ref="chatWindow">
                <div v-for="(msg, index) in messages" :key="index">
                    <div v-if="msg.type === 'system'" :class="['system-message', msg.subType]">
                        {{ msg.text }}
                    </div>
                    <div v-else class="message">
                        <span class="sender">{{ msg.user }}:</span>
                        <span>{{ msg.text }}</span>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <input v-model="newMessage" @keyup.enter="sendMessage" placeholder="Type a message..."
                    :disabled="!isConnected">
                <button @click="sendMessage" :disabled="!isConnected">Send</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, nextTick } = Vue;

        createApp({
            setup() {
                const socket = ref(null);
                const isConnected = ref(false);
                const connectionStatus = ref('Disconnected');
                const messages = ref([]);
                const users = ref([]);
                const newMessage = ref('');
                const username = ref('User' + Math.floor(Math.random() * 10000));
                const previousUsername = ref('');
                const chatWindow = ref(null);

                const sortedUsers = computed(() => {
                    return [...users.value].sort((a, b) => a.localeCompare(b));
                });

                const toggleConnection = () => {
                    if (isConnected.value) {
                        disconnect();
                    } else {
                        connect();
                    }
                };

                const connect = () => {
                    if (!username.value.trim()) {
                        alert("Please enter a username");
                        return;
                    }

                    connectionStatus.value = 'Connecting...';
                    socket.value = new WebSocket('ws://localhost:5000');

                    socket.value.onopen = () => {
                        isConnected.value = true;
                        connectionStatus.value = 'Connected';
                        previousUsername.value = username.value;
                        socket.value.send(JSON.stringify({ type: 'join', user: username.value }));
                    };

                    socket.value.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);

                            if (data.type === 'userlist') {
                                users.value = data.users;
                            } else {
                                messages.value.push(data);
                                scrollToBottom();
                            }
                        } catch (e) {
                            console.error("Failed to parse message", e);
                        }
                    };

                    socket.value.onclose = () => {
                        isConnected.value = false;
                        connectionStatus.value = 'Disconnected';
                        socket.value = null;
                        users.value = []; // Clear user list on disconnect
                        messages.value.push({ type: 'system', subType: 'error', text: 'You have been disconnected.' });
                        scrollToBottom();
                    };

                    socket.value.onerror = (error) => {
                        console.error('WebSocket Error:', error);
                    };
                };

                const disconnect = () => {
                    if (socket.value) {
                        socket.value.close();
                    }
                };

                const handleRename = () => {
                    if (isConnected.value && username.value.trim() && username.value !== previousUsername.value) {
                        socket.value.send(JSON.stringify({
                            type: 'rename',
                            user: username.value
                        }));
                        previousUsername.value = username.value;
                    }
                };

                const sendMessage = () => {
                    if (newMessage.value.trim() && isConnected.value) {
                        const payload = JSON.stringify({
                            type: 'message',
                            text: newMessage.value
                        });
                        socket.value.send(payload);
                        newMessage.value = '';
                    }
                };

                const scrollToBottom = () => {
                    nextTick(() => {
                        if (chatWindow.value) {
                            chatWindow.value.scrollTop = chatWindow.value.scrollHeight;
                        }
                    });
                };

                onMounted(() => {
                    connect();
                });

                onUnmounted(() => {
                    disconnect();
                });

                return {
                    isConnected,
                    connectionStatus,
                    messages,
                    users: sortedUsers,
                    newMessage,
                    username,
                    toggleConnection,
                    sendMessage,
                    handleRename,
                    chatWindow
                };
            }
        }).mount('#app');
    </script>
</body>

</html>